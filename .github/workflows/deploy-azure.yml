name: üöÄ Deploy to Azure

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  # Configuration Azure
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  
  # Configuration Terraform
  TF_VAR_admin_email: ${{ secrets.ADMIN_EMAIL }}
  TF_VAR_project_name: "portail-cloud"
  TF_VAR_environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }}
  TF_VAR_location: "West Europe"

jobs:
  # =====================================================
  # BUILD & TEST
  # =====================================================
  build-and-test:
    name: üî® Build & Test
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üê≥ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: üì¶ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          dashboard-backend/package-lock.json
          dashboard-frontend/package-lock.json

    # Test Backend
    - name: üß™ Test Backend
      run: |
        cd dashboard-backend
        npm ci
        npm run build
        npm run test --if-present
        
    # Test Frontend
    - name: üß™ Test Frontend
      run: |
        cd dashboard-frontend
        npm ci
        npm run build
        
    # Build Docker Images (sans push pour les tests)
    - name: üê≥ Build Docker Images
      run: |
        docker build -t portail-backend:test ./dashboard-backend
        docker build -t portail-frontend:test ./dashboard-frontend

  # =====================================================
  # DEPLOY INFRASTRUCTURE
  # =====================================================
  deploy-infrastructure:
    name: üèóÔ∏è Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    
    outputs:
      registry_url: ${{ steps.terraform-output.outputs.registry_url }}
      resource_group: ${{ steps.terraform-output.outputs.resource_group }}
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üîê Azure Login
      uses: azure/login@v1
      with:
        creds: |
          {
            "clientId": "${{ env.AZURE_CLIENT_ID }}",
            "clientSecret": "${{ env.AZURE_CLIENT_SECRET }}",
            "subscriptionId": "${{ env.AZURE_SUBSCRIPTION_ID }}",
            "tenantId": "${{ env.AZURE_TENANT_ID }}"
          }

    - name: ‚öôÔ∏è Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: latest
        terraform_wrapper: false

    - name: üèóÔ∏è Terraform Init
      working-directory: ./terraform/azure
      run: terraform init

    - name: üìã Terraform Plan
      working-directory: ./terraform/azure
      run: |
        terraform plan -out=tfplan \
          -var="admin_email=${{ env.TF_VAR_admin_email }}" \
          -var="project_name=${{ env.TF_VAR_project_name }}" \
          -var="environment=${{ env.TF_VAR_environment }}" \
          -var="location=${{ env.TF_VAR_location }}"

    - name: üöÄ Terraform Apply
      working-directory: ./terraform/azure
      run: terraform apply -auto-approve tfplan

    - name: üì§ Get Terraform Outputs
      id: terraform-output
      working-directory: ./terraform/azure
      run: |
        echo "registry_url=$(terraform output -raw container_registry_url)" >> $GITHUB_OUTPUT
        echo "resource_group=$(terraform output -raw resource_group_name)" >> $GITHUB_OUTPUT

  # =====================================================
  # BUILD & PUSH IMAGES
  # =====================================================
  build-and-push:
    name: üê≥ Build & Push Images
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üîê Azure Login
      uses: azure/login@v1
      with:
        creds: |
          {
            "clientId": "${{ env.AZURE_CLIENT_ID }}",
            "clientSecret": "${{ env.AZURE_CLIENT_SECRET }}",
            "subscriptionId": "${{ env.AZURE_SUBSCRIPTION_ID }}",
            "tenantId": "${{ env.AZURE_TENANT_ID }}"
          }

    - name: üê≥ Login to Azure Container Registry
      run: |
        REGISTRY_NAME="${{ needs.deploy-infrastructure.outputs.registry_url }}"
        az acr login --name "${REGISTRY_NAME%.azurecr.io}"

    - name: üê≥ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # Build & Push Backend
    - name: üèóÔ∏è Build & Push Backend
      uses: docker/build-push-action@v5
      with:
        context: ./dashboard-backend
        file: ./dashboard-backend/Dockerfile
        push: true
        tags: |
          ${{ needs.deploy-infrastructure.outputs.registry_url }}/portail-backend:latest
          ${{ needs.deploy-infrastructure.outputs.registry_url }}/portail-backend:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    # Build & Push Frontend
    - name: üèóÔ∏è Build & Push Frontend
      uses: docker/build-push-action@v5
      with:
        context: ./dashboard-frontend
        file: ./dashboard-frontend/Dockerfile
        push: true
        tags: |
          ${{ needs.deploy-infrastructure.outputs.registry_url }}/portail-frontend:latest
          ${{ needs.deploy-infrastructure.outputs.registry_url }}/portail-frontend:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # =====================================================
  # DEPLOY APPLICATIONS
  # =====================================================
  deploy-apps:
    name: üöÄ Deploy Applications
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, build-and-push]
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üîê Azure Login
      uses: azure/login@v1
      with:
        creds: |
          {
            "clientId": "${{ env.AZURE_CLIENT_ID }}",
            "clientSecret": "${{ env.AZURE_CLIENT_SECRET }}",
            "subscriptionId": "${{ env.AZURE_SUBSCRIPTION_ID }}",
            "tenantId": "${{ env.AZURE_TENANT_ID }}"
          }

    - name: üîÑ Update Container Apps
      run: |
        REGISTRY_URL="${{ needs.deploy-infrastructure.outputs.registry_url }}"
        RESOURCE_GROUP="${{ needs.deploy-infrastructure.outputs.resource_group }}"
        ENVIRONMENT="${{ env.TF_VAR_environment }}"
        
        # Mise √† jour Backend
        az containerapp update \
          --name "portail-cloud-${ENVIRONMENT}-backend" \
          --resource-group "$RESOURCE_GROUP" \
          --image "${REGISTRY_URL}/portail-backend:${{ github.sha }}"
          
        # Mise √† jour Frontend  
        az containerapp update \
          --name "portail-cloud-${ENVIRONMENT}-frontend" \
          --resource-group "$RESOURCE_GROUP" \
          --image "${REGISTRY_URL}/portail-frontend:${{ github.sha }}"

    - name: ‚úÖ Verify Deployment
      run: |
        RESOURCE_GROUP="${{ needs.deploy-infrastructure.outputs.resource_group }}"
        ENVIRONMENT="${{ env.TF_VAR_environment }}"
        
        # V√©rifier le backend
        az containerapp show \
          --name "portail-cloud-${ENVIRONMENT}-backend" \
          --resource-group "$RESOURCE_GROUP" \
          --query "properties.configuration.ingress.fqdn" -o tsv
          
        # V√©rifier le frontend
        az containerapp show \
          --name "portail-cloud-${ENVIRONMENT}-frontend" \
          --resource-group "$RESOURCE_GROUP" \
          --query "properties.configuration.ingress.fqdn" -o tsv

  # =====================================================
  # POST-DEPLOYMENT TESTS
  # =====================================================
  post-deployment-tests:
    name: üß™ Post-Deployment Tests
    runs-on: ubuntu-latest
    needs: deploy-apps
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üîê Azure Login
      uses: azure/login@v1
      with:
        creds: |
          {
            "clientId": "${{ env.AZURE_CLIENT_ID }}",
            "clientSecret": "${{ env.AZURE_CLIENT_SECRET }}",
            "subscriptionId": "${{ env.AZURE_SUBSCRIPTION_ID }}",
            "tenantId": "${{ env.AZURE_TENANT_ID }}"
          }

    - name: üß™ Health Check Tests
      run: |
        RESOURCE_GROUP="${{ needs.deploy-infrastructure.outputs.resource_group }}"
        ENVIRONMENT="${{ env.TF_VAR_environment }}"
        
        # R√©cup√©rer l'URL du backend
        BACKEND_URL=$(az containerapp show \
          --name "portail-cloud-${ENVIRONMENT}-backend" \
          --resource-group "$RESOURCE_GROUP" \
          --query "properties.configuration.ingress.fqdn" -o tsv)
          
        # Test Health Check
        curl -f "https://${BACKEND_URL}/api/health" || exit 1
        
        # R√©cup√©rer l'URL du frontend
        FRONTEND_URL=$(az containerapp show \
          --name "portail-cloud-${ENVIRONMENT}-frontend" \
          --resource-group "$RESOURCE_GROUP" \
          --query "properties.configuration.ingress.fqdn" -o tsv)
          
        # Test Frontend
        curl -f "https://${FRONTEND_URL}/" || exit 1
        
        echo "‚úÖ Tous les tests de sant√© ont r√©ussi !"

    - name: üìä Deployment Summary
      run: |
        echo "üéâ D√©ploiement r√©ussi !"
        echo "üìã R√©sum√© :"
        echo "   - Environnement: ${{ env.TF_VAR_environment }}"
        echo "   - Commit: ${{ github.sha }}"
        echo "   - Branch: ${{ github.ref_name }}"
        echo "   - Resource Group: ${{ needs.deploy-infrastructure.outputs.resource_group }}"