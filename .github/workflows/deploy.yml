# GitHub Actions d√©sactiv√© - Utilisez le script deploy-azure.ps1 pour d√©ployer directement

# name: Deploy Container Platform
# on:
#   workflow_dispatch:  # Manual trigger only
# 
# env:
#   AZURE_RESOURCE_GROUP: rg-container-platform
#   APP_NAME_PREFIX: container-platform

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
    
#     steps:
#     - name: Checkout
#       uses: actions/checkout@v4

#     - name: Setup Node.js
#       uses: actions/setup-node@v4
#       with:
#         node-version: '18'

#     # Test backend
#     - name: Test Backend
#       working-directory: ./dashboard-backend
#       run: |
#         npm ci
#         npm run build
#         npm test -- --passWithNoTests

#     # Test frontend
#     - name: Test Frontend
#       working-directory: ./dashboard-frontend
#       run: |
#         npm ci
#         npm run build

#     # Login to Azure using credentials
#     - name: Azure Login
#       uses: azure/login@v2
#       with:
#         creds: ${{ secrets.AZURE_CREDENTIALS }}

#     # Setup Terraform
#     - name: Setup Terraform
#       uses: hashicorp/setup-terraform@v3

#     # Deploy infrastructure
#     - name: Deploy Infrastructure
#       working-directory: ./terraform
#       run: |
#         terraform init
#         terraform plan -var="db_admin_password=${{ secrets.DB_ADMIN_PASSWORD }}" -out=tfplan
#         terraform apply -auto-approve tfplan

#     # Package applications
#     - name: Package Applications
#       run: |
#         # Backend package
#         cd dashboard-backend
#         npm ci --production
#         zip -r ../backend.zip . -x "*.log" "coverage/*" "*.test.js"
#         cd ..
        
#         # Frontend package (already built)
#         cd dashboard-frontend
#         zip -r ../frontend.zip out/ 2>/dev/null || zip -r ../frontend.zip build/ || zip -r ../frontend.zip dist/ || echo "Using default files"
#         cd ..

#     # Deploy applications
#     - name: Deploy Applications
#       run: |
#         # Get App Service names from Terraform outputs or use defaults
#         BACKEND_APP="${{ env.APP_NAME_PREFIX }}-api"
#         FRONTEND_APP="${{ env.APP_NAME_PREFIX }}-web"
        
#         # Deploy backend
#         az webapp deployment source config-zip \
#           --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
#           --name $BACKEND_APP \
#           --src backend.zip
        
#         # Deploy frontend
#         az webapp deployment source config-zip \
#           --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
#           --name $FRONTEND_APP \
#           --src frontend.zip

#     # Health check
#     - name: Health Check
#       run: |
#         echo "‚è≥ Waiting for deployment to stabilize..."
#         sleep 30
        
#         BACKEND_URL="https://${{ env.APP_NAME_PREFIX }}-api.azurewebsites.net"
        
#         # Check backend health
#         if curl -f "$BACKEND_URL/api/health" --max-time 30; then
#           echo "‚úÖ Backend is healthy!"
#         else
#           echo "‚ùå Backend health check failed"
#           exit 1
#         fi
        
#         echo "üéâ Deployment completed successfully!"