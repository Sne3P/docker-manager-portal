#!/bin/bash\n\n# Azure Deployment Script for Container Management Platform\n# This script deploys the complete infrastructure to Azure\n#\n# Prerequisites:\n# - Azure CLI installed and logged in\n# - Terraform installed\n# - Docker installed\n\nset -e\n\necho \"ğŸš€ Starting Azure deployment for Container Management Platform\"\n\n# Configuration\nPROJECT_NAME=\"container-platform\"\nENVIRONMENT=\"prod\"\nRESOURCE_GROUP=\"rg-${PROJECT_NAME}-${ENVIRONMENT}\"\n\n# Check prerequisites\necho \"ğŸ“‹ Checking prerequisites...\"\n\nif ! command -v az &> /dev/null; then\n    echo \"âŒ Azure CLI is not installed. Please install it first.\"\n    exit 1\nfi\n\nif ! command -v terraform &> /dev/null; then\n    echo \"âŒ Terraform is not installed. Please install it first.\"\n    exit 1\nfi\n\nif ! command -v docker &> /dev/null; then\n    echo \"âŒ Docker is not installed. Please install it first.\"\n    exit 1\nfi\n\n# Check if user is logged in to Azure\nif ! az account show &> /dev/null; then\n    echo \"âŒ Not logged in to Azure. Please run 'az login' first.\"\n    exit 1\nfi\n\necho \"âœ… All prerequisites satisfied\"\n\n# Get or create terraform.tfvars\nif [ ! -f \"terraform/terraform.tfvars\" ]; then\n    echo \"ğŸ“ Creating terraform.tfvars from template...\"\n    cp terraform/terraform.tfvars.example terraform/terraform.tfvars\n    \n    echo \"âš ï¸  Please edit terraform/terraform.tfvars and set your values:\"\n    echo \"   - admin_password: Set a secure database password\"\n    echo \"   - project_name: Customize if needed\"\n    echo \"   - location: Set your preferred Azure region\"\n    echo \"\"\n    echo \"Press Enter when ready to continue...\"\n    read\nfi\n\n# Deploy infrastructure\necho \"ğŸ—ï¸  Deploying infrastructure with Terraform...\"\ncd terraform\n\nterraform init\nterraform plan\necho \"ğŸ¤” Review the plan above. Press Enter to apply or Ctrl+C to cancel...\"\nread\n\nterraform apply\n\n# Get outputs\nREGISTRY_NAME=$(terraform output -raw container_registry_url)\nBACKEND_URL=$(terraform output -raw backend_url)\nFRONTEND_URL=$(terraform output -raw frontend_url)\n\necho \"ğŸ“Š Infrastructure deployed successfully!\"\necho \"   Registry: ${REGISTRY_NAME}\"\necho \"   Backend:  ${BACKEND_URL}\"\necho \"   Frontend: ${FRONTEND_URL}\"\n\ncd ..\n\n# Build and push Docker images\necho \"ğŸ³ Building and pushing Docker images...\"\n\n# Get registry credentials\nREGISTRY_USER=$(az acr credential show --name ${REGISTRY_NAME##*/} --query \"username\" -o tsv)\nREGISTRY_PASS=$(az acr credential show --name ${REGISTRY_NAME##*/} --query \"passwords[0].value\" -o tsv)\n\n# Login to registry\necho $REGISTRY_PASS | docker login $REGISTRY_NAME -u $REGISTRY_USER --password-stdin\n\n# Build and push backend\necho \"Building backend image...\"\ndocker build -t $REGISTRY_NAME/backend:latest ./dashboard-backend\ndocker push $REGISTRY_NAME/backend:latest\n\n# Build and push frontend\necho \"Building frontend image...\"\ndocker build -t $REGISTRY_NAME/frontend:latest ./dashboard-frontend\ndocker push $REGISTRY_NAME/frontend:latest\n\necho \"âœ… Images pushed successfully!\"\n\n# Deploy applications\necho \"ğŸš€ Deploying applications to Azure App Service...\"\n\naz webapp deployment container config --name \"app-${PROJECT_NAME}-api-${ENVIRONMENT}\" \\\n    --resource-group \"$RESOURCE_GROUP\" \\\n    --docker-custom-image-name \"$REGISTRY_NAME/backend:latest\" \\\n    --docker-registry-server-url \"https://$REGISTRY_NAME\" \\\n    --docker-registry-server-user \"$REGISTRY_USER\" \\\n    --docker-registry-server-password \"$REGISTRY_PASS\"\n\naz webapp deployment container config --name \"app-${PROJECT_NAME}-web-${ENVIRONMENT}\" \\\n    --resource-group \"$RESOURCE_GROUP\" \\\n    --docker-custom-image-name \"$REGISTRY_NAME/frontend:latest\" \\\n    --docker-registry-server-url \"https://$REGISTRY_NAME\" \\\n    --docker-registry-server-user \"$REGISTRY_USER\" \\\n    --docker-registry-server-password \"$REGISTRY_PASS\"\n\n# Wait for deployment\necho \"â³ Waiting for applications to start...\"\nsleep 60\n\n# Health check\necho \"ğŸ¥ Running health check...\"\nif curl -f \"$BACKEND_URL/api/health\" > /dev/null 2>&1; then\n    echo \"âœ… Backend health check passed!\"\nelse\n    echo \"âš ï¸  Backend health check failed. Check logs in Azure Portal.\"\nfi\n\necho \"\"\necho \"ğŸ‰ Deployment completed successfully!\"\necho \"\"\necho \"ğŸ“‹ Application URLs:\"\necho \"   Backend API: $BACKEND_URL\"\necho \"   Frontend:    $FRONTEND_URL\"\necho \"\"\necho \"ğŸ” Default login credentials:\"\necho \"   Admin: admin / admin123\"\necho \"   Client: client1 / client123\"\necho \"\"\necho \"ğŸ“š Next steps:\"\necho \"   1. Update default passwords in production\"\necho \"   2. Configure custom domain names\"\necho \"   3. Set up monitoring and alerts\"\necho \"   4. Configure backup policies\"\necho \"\"